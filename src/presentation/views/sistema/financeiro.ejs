<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão Financeira</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/financeiro/financeiro.css" />
</head>
<body>
  <div class="container">

    <header class="page-head">
      <div>
        <h1>Gestão Financeira</h1>
        <p class="subtitle">Entradas, saídas e fixos com filtros rápidos.</p>
      </div>
      <div class="head-actions">
        <a href="/dashboard" class="btn btn--ghost">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <button class="btn btn--primary" id="btnNovoLancamento">
          <i class="fas fa-plus-circle"></i>
          Adicionar Lançamento
        </button>
      </div>
    </header>

    <section class="cards">
      <div class="card kpi entrada">
        <span class="kpi-label">Total de Entradas</span>
        <span class="kpi-value">R$ <%= Number(totalEntradas || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
      </div>
      <div class="card kpi saida">
        <span class="kpi-label">Total de Saídas</span>
        <span class="kpi-value">R$ <%= Number(totalSaidas || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
      </div>
      <div class="card kpi registros">
        <span class="kpi-label">Lançamentos</span>
        <span class="kpi-value"><%= (dados && dados.length) ? dados.length : 0 %></span>
      </div>
      <%
        const _fixosArr = (typeof gastosFixos !== 'undefined' && Array.isArray(gastosFixos)) ? gastosFixos : [];
        const _totalFixosCalc = _fixosArr.reduce((acc, g) => acc + Number(g.valor || 0), 0);
        const _totalFixos = (typeof totalFixos !== 'undefined') ? Number(totalFixos || 0) : _totalFixosCalc;

        const _saldoBase = Number((typeof saldoFinal !== 'undefined' ? saldoFinal : (Number(totalEntradas||0) - Number(totalSaidas||0))) || 0);
        const _saldoComFixos = (typeof saldoComFixos !== 'undefined') ? Number(saldoComFixos || 0) : (_saldoBase - _totalFixos);
      %>
      <div class="card kpi fixos">
        <span class="kpi-label">Gastos Fixos</span>
        <span class="kpi-value">R$ <%= _totalFixos.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
      </div>
      <div class="card kpi saldo">
        <span class="kpi-label">Saldo Final (com fixos)</span>
        <span class="kpi-value">R$ <%= _saldoComFixos.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
      </div>
    </section>

    <!-- Seção de Metas Financeiras -->
    <% if (progressoMeta) { %>
    <section class="metas-section">
      <div class="metas-header">
        <h2><i class="fas fa-bullseye"></i> Metas do Mês</h2>
        <button class="btn btn--secondary btn-sm" id="btnEditarMetas">
          <i class="fas fa-edit"></i> Editar Metas
        </button>
      </div>
      
      <div class="metas-grid">
        <!-- Meta de Receita -->
        <div class="meta-card <%= progressoMeta.alertas.receita_atingida ? 'atingida' : '' %>">
          <div class="meta-icon receita">
            <i class="fas fa-arrow-up"></i>
          </div>
          <div class="meta-info">
            <h3>Receita</h3>
            <div class="meta-valores">
              <span class="valor-atual">R$ <%= progressoMeta.realizado.receita.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
              <span class="valor-meta">/ R$ <%= progressoMeta.meta.meta_receita.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill receita" style="width: <%= progressoMeta.progresso.receita %>%">
                <span class="progress-text"><%= progressoMeta.progresso.receita.toFixed(0) %>%</span>
              </div>
            </div>
            <% if (progressoMeta.alertas.receita_atingida) { %>
              <div class="meta-alerta sucesso">
                <i class="fas fa-check-circle"></i> Meta atingida!
              </div>
            <% } %>
          </div>
        </div>

        <!-- Meta de Despesa -->
        <div class="meta-card <%= progressoMeta.alertas.despesa_ultrapassada ? 'ultrapassada' : '' %>">
          <div class="meta-icon despesa">
            <i class="fas fa-arrow-down"></i>
          </div>
          <div class="meta-info">
            <h3>Despesa Máxima</h3>
            <div class="meta-valores">
              <span class="valor-atual">R$ <%= progressoMeta.realizado.despesa.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
              <span class="valor-meta">/ R$ <%= progressoMeta.meta.meta_despesa.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill despesa" style="width: <%= progressoMeta.progresso.despesa %>%">
                <span class="progress-text"><%= progressoMeta.progresso.despesa.toFixed(0) %>%</span>
              </div>
            </div>
            <% if (progressoMeta.alertas.despesa_ultrapassada) { %>
              <div class="meta-alerta aviso">
                <i class="fas fa-exclamation-triangle"></i> Meta ultrapassada!
              </div>
            <% } %>
          </div>
        </div>

        <!-- Meta de Economia -->
        <div class="meta-card <%= progressoMeta.alertas.economia_atingida ? 'atingida' : '' %>">
          <div class="meta-icon economia">
            <i class="fas fa-piggy-bank"></i>
          </div>
          <div class="meta-info">
            <h3>Economia</h3>
            <div class="meta-valores">
              <span class="valor-atual">R$ <%= progressoMeta.realizado.economia.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
              <span class="valor-meta">/ R$ <%= progressoMeta.meta.meta_economia.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill economia" style="width: <%= progressoMeta.progresso.economia %>%">
                <span class="progress-text"><%= progressoMeta.progresso.economia.toFixed(0) %>%</span>
              </div>
            </div>
            <% if (progressoMeta.alertas.economia_atingida) { %>
              <div class="meta-alerta sucesso">
                <i class="fas fa-check-circle"></i> Meta atingida!
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </section>
    <% } %>

    <%
      const categoriasUnicas = Array.from(new Set((dados || []).map(d => d?.categoria).filter(Boolean))).sort();
    %>
    <section class="filter-bar">
      <div class="filter-line">
        <div class="filter-item grow">
          <label for="busca">Buscar</label>
          <div class="input-icon">
            <i class="fas fa-magnifying-glass search-icon"></i>
            <input id="busca" type="text" placeholder="Pesquisar por categoria ou tipo..." />
          </div>
        </div>

        <div class="filter-item">
          <label for="filtroCategoria">Categoria</label>
          <select id="filtroCategoria">
            <option value="">Todas</option>
            <% categoriasUnicas.forEach(c => { %>
              <option value="<%= c %>"><%= c %></option>
            <% }) %>
          </select>
        </div>

        <div class="filter-item">
          <label>Período</label>
          <div class="range">
            <input id="filtroDataInicio" type="date" />
            <span class="range-sep">—</span>
            <input id="filtroDataFim" type="date" />
          </div>
        </div>

        <div class="filter-item actions">
          <button class="btn btn--ghost" id="btnHoje">Hoje</button>
          <button class="btn btn--ghost" id="btn7d">7 dias</button>
          <button class="btn btn--ghost" id="btn30d">30 dias</button>
          <button class="btn btn--ghost" id="btnMes">Mês atual</button>
          <button class="btn btn--ghost" id="btnLimparFiltros">Limpar</button>
        </div>
      </div>

      <div class="chip-row" role="tablist" aria-label="Filtro por tipo">
        <button class="chip is-active" data-tipo="todos">Todos</button>
        <button class="chip" data-tipo="entrada"><i class="fa-solid fa-circle-arrow-down"></i> Entradas</button>
        <button class="chip" data-tipo="saida"><i class="fa-solid fa-circle-arrow-up"></i> Saídas</button>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2 class="panel-title"><i class="fas fa-receipt"></i> Lançamentos</h2>
        <div class="panel-actions">
          <button class="btn btn--primary" id="btnNovoLancamento2">
            <i class="fas fa-plus-circle"></i>
            Adicionar
          </button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tabela">
          <thead>
            <tr>
              <th class="sticky">Data</th>
              <th class="sticky">Categoria</th>
              <th class="sticky">Tipo</th>
              <th class="sticky">Valor</th>
              <th class="sticky center">Ações</th>
            </tr>
          </thead>
          <tbody>
          <% if (dados && dados.length) { %>
            <% dados.forEach(d => {
                 const dt = new Date(d.data);
                 const dataFmt = isNaN(dt) ? String(d.data).slice(0,10) : dt.toLocaleDateString('pt-BR');
                 const dataISO = isNaN(dt) ? String(d.data).slice(0,10) : (dt.toISOString().slice(0,10));
            %>
              <tr data-categoria="<%= d.categoria %>" data-tipo="<%= d.tipo %>" data-data="<%= dataISO %>">
                <td data-col="data"><%= dataFmt %></td>
                <td data-col="categoria"><%= d.categoria %></td>
                <td data-col="tipo">
                  <span class="badge <%= d.tipo === 'entrada' ? 'ok' : 'danger' %>">
                    <%= d.tipo %>
                  </span>
                </td>
                <td data-col="valor">R$ <%= Number(d.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                <td class="center">
                  <button type="button" class="btn btn--danger btn--icon" title="Excluir" onclick="confirmarExclusaoLancamento('<%= d.id %>')">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr class="empty-row">
              <td colspan="5">
                <div class="empty">
                  <i class="fa-regular fa-folder-open"></i>
                  <p>Nenhum lançamento encontrado.</p>
                  <button class="btn btn--primary" id="btnEmptyAdd">Adicionar Lançamento</button>
                </div>
              </td>
            </tr>
          <% } %>
          </tbody>
        </table>
      </div>
    </section>

    <hr class="divider" />

    <section class="section-head">
      <div>
        <h2>Gastos Fixos</h2>
        <p class="subtitle">Despesas recorrentes que impactam seu saldo final.</p>
      </div>
      <div class="head-actions">
        <button class="btn btn--primary" id="btnNovoGastoFixo">
          <i class="fas fa-plus-circle"></i>
          Adicionar Gasto Fixo
        </button>
      </div>
    </section>

    <%
      const todasCategoriasFixos = Array.from(new Set((todosGastosFixos || []).map(f => f?.categoria).filter(Boolean))).sort();
    %>
    <section class="filter-bar">
      <div class="filter-line">
        <div class="filter-item grow">
          <label for="buscaFixos">Buscar</label>
          <div class="input-icon">
            <i class="fas fa-magnifying-glass search-icon"></i>
            <input id="buscaFixos" type="text" placeholder="Buscar por nome ou recorrência..." />
          </div>
        </div>

        <div class="filter-item">
          <label for="filtroCategoriaFixos">Categoria</label>
          <select id="filtroCategoriaFixos">
            <option value="">Todas</option>
            <% todasCategoriasFixos.forEach(c => { %>
              <option value="<%= c %>"><%= c %></option>
            <% }) %>
          </select>
        </div>

        <div class="filter-item">
          <label for="filtroRecorrencia">Recorrência</label>
          <select id="filtroRecorrencia">
            <option value="">Todas</option>
            <option value="mensal">Mensal</option>
            <option value="semanal">Semanal</option>
            <option value="anual">Anual</option>
          </select>
        </div>

        <div class="filter-item actions">
          <button class="btn btn--ghost" id="btnLimparFiltrosFixos">Limpar</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="table-wrap">
        <table id="tabelaFixos">
          <thead>
            <tr>
              <th class="sticky">Nome</th>
              <th class="sticky">Categoria</th>
              <th class="sticky">Valor</th>
              <th class="sticky">Recorrência</th>
              <th class="sticky">Início</th>
              <th class="sticky">Fim</th>
              <th class="sticky center">Ações</th>
            </tr>
          </thead>
          <tbody>
          <% if (_fixosArr.length) { %>
            <% _fixosArr.forEach(f => {
                 const di = new Date(f.data_inicio);
                 const df = f.data_fim ? new Date(f.data_fim) : null;
                 const diFmt = isNaN(di) ? String(f.data_inicio).slice(0,10) : di.toLocaleDateString('pt-BR');
                 const dfFmt = df && !isNaN(df) ? df.toLocaleDateString('pt-BR') : (f.data_fim ? String(f.data_fim).slice(0,10) : '-');
            %>
              <tr data-categoria-fixo="<%= f.categoria %>" data-recorrencia="<%= f.recorrencia %>" data-nome="<%= f.nome.toLowerCase() %>">
                <td data-col="nome"><%= f.nome %></td>
                <td data-col="categoria">
                  <span class="badge <%= f.categoria === 'Funcionário' ? 'info' : 'default' %>">
                    <%= f.categoria %>
                  </span>
                </td>
                <td data-col="valor">R$ <%= Number(f.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                <td data-col="recorrencia" class="cap"><%= f.recorrencia %></td>
                <td data-col="inicio"><%= diFmt %></td>
                <td data-col="fim"><%= dfFmt %></td>
                <td class="center">
                  <button type="button" class="btn btn--danger btn--icon" title="Excluir" onclick="confirmarExclusaoGastoFixo('<%= f.id %>')">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr class="empty-row">
              <td colspan="7">
                <div class="empty">
                  <i class="fa-regular fa-folder-open"></i>
                  <p>Nenhum gasto fixo cadastrado.</p>
                  <button class="btn btn--primary" id="btnEmptyAddFixo">Adicionar Gasto Fixo</button>
                </div>
              </td>
            </tr>
          <% } %>
          </tbody>
        </table>
      </div>

      <% if (paginacaoFixos && paginacaoFixos.totalPages > 1) { %>
        <div class="pagination">
          <% if (paginacaoFixos.hasPrev) { %>
            <a href="?ano=<%= ano %>&mes=<%= mes %>&pageFixos=<%= paginacaoFixos.currentPage - 1 %>&limitFixos=<%= paginacaoFixos.limit %>" class="btn btn--ghost">
              <i class="fas fa-chevron-left"></i> Anterior
            </a>
          <% } %>
          
          <span class="pagination-info">
            Página <%= paginacaoFixos.currentPage %> de <%= paginacaoFixos.totalPages %>
            (<%= paginacaoFixos.totalRecords %> registros)
          </span>
          
          <% if (paginacaoFixos.hasNext) { %>
            <a href="?ano=<%= ano %>&mes=<%= mes %>&pageFixos=<%= paginacaoFixos.currentPage + 1 %>&limitFixos=<%= paginacaoFixos.limit %>" class="btn btn--ghost">
              Próxima <i class="fas fa-chevron-right"></i>
            </a>
          <% } %>
        </div>
      <% } %>
    </section>
  </div>

  <!-- Modal de Edição de Metas -->
  <div id="modalMetas" class="modal">
    <div class="modal-content">
      <span class="close" id="fecharModalMetas" aria-label="Fechar">&times;</span>
      <h3><i class="fas fa-bullseye"></i> Definir Metas do Mês</h3>
      
      <form id="formMetas">
        <input type="hidden" id="meta_id" name="meta_id" value="<%= metaMes ? metaMes.id : '' %>">
        
        <div class="form-group">
          <label for="meta_receita">
            <i class="fas fa-arrow-up" style="color: #10b981;"></i> Meta de Receita
          </label>
          <input type="text" 
                 id="meta_receita" 
                 name="meta_receita"
                 placeholder="Ex: 1.200,00"
                 value="<%= metaMes ? metaMes.meta_receita : 0 %>"
                 required />
          <small>Quanto você espera receber este mês</small>
        </div>

        <div class="form-group">
          <label for="meta_despesa">
            <i class="fas fa-arrow-down" style="color: #ef4444;"></i> Meta de Despesa Máxima
          </label>
          <input type="text" 
                 id="meta_despesa" 
                 name="meta_despesa"
                 placeholder="Ex: 1.200,00"
                 value="<%= metaMes ? metaMes.meta_despesa : 0 %>"
                 required />
          <small>Quanto você pode gastar no máximo</small>
        </div>

        <div class="form-group">
          <label for="meta_economia">
            <i class="fas fa-piggy-bank" style="color: #8b5cf6;"></i> Meta de Economia
          </label>
          <input type="text" 
                 id="meta_economia" 
                 name="meta_economia"
                 placeholder="Ex: 1.200,00"
                 value="<%= metaMes ? metaMes.meta_economia : 0 %>"
                 required />
          <small>Quanto você quer economizar este mês</small>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
          <button type="button" class="btn btn--secondary" id="cancelarMetas">Cancelar</button>
          <button type="submit" class="btn btn--primary">
            <i class="fas fa-save"></i> Salvar Metas
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="modalLancamento" class="modal">
    <div class="modal-content">
      <span id="fecharModal" class="close" aria-label="Fechar">&times;</span>
      <h3>Novo Lançamento</h3>

      <form method="POST" action="/financeiro/create" id="formLancamento">
        <select name="tipo" required>
          <option value="">Selecione</option>
          <option value="entrada">Entrada</option>
          <option value="saida">Saída</option>
        </select>

        <select name="categoria" required>
          <option value="">Selecione</option>
          <option value="Alimento">Alimento</option>
          <option value="Bebida">Bebida</option>
          <option value="Transporte">Transporte</option>
          <option value="Outros">Outros</option>
        </select>

        <input type="number" name="valor" placeholder="Valor" step="0.01" inputmode="decimal" required />
        <input type="date" name="data" required />

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px;">
          <button type="button" class="btn btn--secondary" id="cancelarLancamento">Cancelar</button>
          <button type="submit" class="btn btn--primary">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modalGastoFixo" class="modal">
    <div class="modal-content">
      <span id="fecharModalFixo" class="close" aria-label="Fechar">&times;</span>
      <h3>Novo Gasto Fixo</h3>

      <form id="formGastoFixo" method="POST" action="/gastos-fixos">
        <input type="text" name="nome" placeholder="Ex: Aluguel, Internet..." required />
        <input type="number" name="valor" placeholder="Valor" step="0.01" inputmode="decimal" required />

        <label style="font-size:.9rem; opacity:.8; margin-top:8px;">Recorrência</label>
        <select name="recorrencia" required>
          <option value="mensal">Mensal</option>
          <option value="semanal">Semanal</option>
          <option value="anual">Anual</option>
        </select>

        <label style="font-size:.9rem; opacity:.8; margin-top:8px;">Período</label>
        <input type="date" name="data_inicio" required />
        <input type="date" name="data_fim" placeholder="Opcional" />

        <textarea name="observacao" placeholder="Observações (opcional)" rows="3"></textarea>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px;">
          <button type="button" class="btn btn--secondary" id="cancelarGastoFixo">Cancelar</button>
          <button type="submit" class="btn btn--primary">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <script nonce="<%= cspNonce %>" src="/financeiro/financeiro.js"></script>
</body>
</html>
