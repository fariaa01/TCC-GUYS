<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= empresaNome %> — Cardápio</title>
  <link rel="stylesheet" href="/cardapio/cardapio.css" />
</head>
<body>
  <div class="layout-cardapio">
    <main class="col-catalogo">
      <div class="container">
        <header class="topbar">
          <h1><%= empresaNome %></h1>
          <div style="display:flex; gap:10px; align-items:center;">
            <a href="/lojas" class="btn-ghost">Trocar loja</a>
            <button type="button" id="btnToggleCart" class="btn-carrinho" aria-label="Ver carrinho" data-endpoint-listar="/carrinho">
              <span class="icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 6h15l-2 8H8L6 6Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                  <path d="M6 6 5 3H2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <circle cx="9.5" cy="18.5" r="1.6" fill="currentColor"/>
                  <circle cx="17.5" cy="18.5" r="1.6" fill="currentColor"/>
                </svg>
              </span>
              <span class="label">Carrinho</span>
              <span id="badge-carrinho" class="badge-carrinho">0</span>
            </button>
          </div>
        </header>

        <%
          const temCategorias = (typeof categorias !== 'undefined' && Array.isArray(categorias) && categorias.length > 0);
          const listaChips = temCategorias ? categorias : ['Todos','Bebidas','Hamburguer','Salada','Apimentados','Doces'];
        %>

        <nav class="filtros" aria-label="Categorias do cardápio">
          <% listaChips.forEach(function(c, idx){ %>
            <button class="chip <%= idx === 0 ? 'is-active' : '' %>" type="button" data-filter="<%= c %>"><%= c %></button>
          <% }) %>
          <button class="btn-primary" type="button" id="btnVerTudo">Ver tudo</button>
        </nav>

        <% if (!itens || !itens.length) { %>
          <p class="vazio">Este restaurante ainda não tem itens no cardápio.</p>
        <% } else { %>
          <div class="grid-cards">
            <% itens.forEach(function(i){ %>
              <div class="card" data-cat="<%= i.categoria || 'Outros' %>">
                <% if (i.desconto) { %>
                  <span class="badge"><%= i.desconto %>%</span>
                <% } %>
                <% if (typeof i.avaliacao !== 'undefined' && i.avaliacao !== null) { %>
                  <span class="price-badge"><%= Number(i.avaliacao).toFixed(1) %> ★</span>
                <% } %>

                <% if (i.imagem) { %>
                  <img src="/uploads/<%= i.imagem %>" alt="<%= i.nome_prato || 'Item do cardápio' %>">
                <% } else { %>
                  <div class="img-placeholder" aria-label="Sem imagem"></div>
                <% } %>

                <div class="card-body">
                  <h3 class="titulo"><%= i.nome_prato %></h3>

                  <% if (i.descricao) { %>
                    <p class="desc"><%= i.descricao %></p>
                  <% } else { %>
                    <p class="desc muted">Sem descrição.</p>
                  <% } %>

                  <div class="card-footer">
                    <% if (i.tamanhos && Array.isArray(i.tamanhos) && i.tamanhos.length > 0) { %>
                      <div class="precos-multiplos">
                        <strong class="preco-range">
                          <% 
                            const precos = i.tamanhos.map(t => Number(t.preco || 0)).filter(p => p > 0);
                            const menorPreco = precos.length > 0 ? Math.min(...precos) : Number(i.preco || 0);
                          %>
                          A partir de R$ <%= menorPreco.toFixed(2).replace('.', ',') %>
                        </strong>
                        <small class="tamanhos-info"><%= i.tamanhos.length %> tamanhos disponíveis</small>
                      </div>
                      <button
                        type="button"
                        class="btn adicionar-carrinho btn-escolher-tamanho"
                        data-produto-id="<%= i.id %>"
                        data-id="<%= i.id %>"
                        data-nome="<%= i.nome_prato %>"
                        data-img="<%= i.imagem ? ('/uploads/' + i.imagem) : '' %>"
                        data-tamanhos='<%- JSON.stringify(i.tamanhos || []) %>'
                        aria-label="Escolher tamanho para <%= i.nome_prato %>">
                        Escolher Tamanho
                      </button>
                    <% } else { %>
                      <strong class="preco">R$ <%= Number(i.preco).toFixed(2).replace('.', ',') %></strong>
                      <button
                        type="button"
                        class="btn adicionar-carrinho"
                        data-produto-id="<%= i.id %>"
                        data-id="<%= i.id %>"
                        data-preco="<%= Number(i.preco) %>"
                        data-nome="<%= i.nome_prato %>"
                        data-img="<%= i.imagem ? ('/uploads/' + i.imagem) : '' %>"
                        data-endpoint-adicionar="/carrinho/adicionar"
                        aria-label="Adicionar <%= i.nome_prato %> ao carrinho">
                        Adicionar
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </main>

    <aside class="col-carrinho" id="cart"
           data-endpoint-listar="/carrinho"
           data-endpoint-remover="/carrinho/remover"
           data-endpoint-atualizar="/carrinho/atualizar"
           data-endpoint-finalizar="/carrinho/finalizar">
      <header class="cart-header" style="display:flex; align-items:center; gap:10px;">
        <h2 style="margin:0;">Meu Pedido</h2>
        <button type="button" class="cart-close" id="closeCart" aria-label="Fechar">✕</button>
      </header>

      <div class="tabs" style="margin-top:8px;">
        <button class="tab active"  type="button" data-mode="dine">Comer no local</button>
        <button class="tab"         type="button" data-mode="pickup">Retirar</button>
        <button class="tab"         type="button" data-mode="delivery">Entrega</button>
      </div>

      <section id="carrinho-container" class="cart-list"></section>

      <section class="resumo">
        <div class="linha"><span>Itens</span><strong id="subtotal">R$ 0,00</strong></div>
        <div class="linha desconto"><span>Desconto</span><strong id="taxas">R$ 0,00</strong></div>
        <div class="linha total"><span>Total</span><strong id="total">R$ 0,00</strong></div>
      </section>

      <section class="pagamentos">
        <h4>Pagamentos</h4>
        <div class="opcoes">
          <button class="pay active" type="button" data-pay="cash">Dinheiro</button>
          <button class="pay"        type="button" data-pay="debit">Débito</button>
          <button class="pay"        type="button" data-pay="credit">Crédito</button>
          <button class="pay"        type="button" data-pay="ewallet">Pix</button>
        </div>
      </section>

      <footer class="cart-footer">
        <button id="limpar" class="btn-outline" type="button">Limpar carrinho</button>
        <a href="/checkout" class="btn-primary" id="ir-checkout">Checkout</a>
      </footer>
    </aside>

    <div class="cart-backdrop" id="cartBackdrop"></div>
  </div>

  <!-- ========== MODAL LOGIN/CADASTRO DE CLIENTE ========== -->
  <div id="authModal" class="auth-modal" aria-hidden="true">
    <div class="auth-backdrop" data-close-auth></div>
    <div class="auth-dialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <header class="auth-header">
        <h3 id="authTitle">Identifique-se</h3>
        <button class="auth-close" type="button" aria-label="Fechar" data-close-auth>✕</button>
      </header>

      <nav class="auth-tabs" role="tablist" aria-label="Acesso do cliente">
        <button class="auth-tab is-active" role="tab" aria-selected="true" aria-controls="pane-login" id="tab-login">Entrar</button>
        <button class="auth-tab" role="tab" aria-selected="false" aria-controls="pane-cadastro" id="tab-cadastro">Cadastrar</button>
      </nav>

      <section id="pane-login" class="auth-pane is-active" role="tabpanel" aria-labelledby="tab-login">
        <form id="formLogin" class="auth-form" autocomplete="on" data-endpoint-login="/cliente/login">
          <input type="hidden" name="next" value="/checkout" />
          <label class="auth-field">
            <span>Email</span>
            <input type="email" name="email" required placeholder="voce@email.com" />
          </label>
          <label class="auth-field">
            <span>Senha</span>
            <input type="password" name="senha" required placeholder="Sua senha" minlength="4" />
          </label>
          <button class="auth-submit" type="submit">Entrar</button>
          <p class="auth-feedback" id="loginFeedback" aria-live="polite"></p>
        </form>
      </section>

      <section id="pane-cadastro" class="auth-pane" role="tabpanel" aria-labelledby="tab-cadastro" hidden>
        <form id="formCadastro" class="auth-form" autocomplete="on" data-endpoint-cadastro="/cliente/cadastrar">
          <input type="hidden" name="next" value="/checkout" />
          <label class="auth-field">
            <span>Nome</span>
            <input type="text" name="nome" required placeholder="Seu nome" />
          </label>
          <label class="auth-field">
            <span>Email</span>
            <input type="email" name="email" required placeholder="voce@email.com" />
          </label>
          <label class="auth-field">
            <span>Senha</span>
            <input type="password" name="senha" required placeholder="Crie uma senha" minlength="4" />
          </label>
          <button class="auth-submit" type="submit">Criar conta</button>
          <p class="auth-feedback" id="cadastroFeedback" aria-live="polite"></p>
        </form>
      </section>
    </div>
  </div>

  <div id="modalTamanhos" class="modal-overlay" aria-hidden="true">
    <div class="modal-content modal-tamanhos" role="dialog" aria-labelledby="modal-tamanhos-title">
      <header class="modal-header">
        <h3 id="modal-tamanhos-title">Escolha o tamanho</h3>
        <button type="button" class="modal-close" aria-label="Fechar modal">&times;</button>
      </header>
      
      <div class="modal-body">
        <div class="produto-info">
          <img id="modal-produto-img" src="" alt="" class="produto-thumb">
          <div class="produto-detalhes">
            <h4 id="modal-produto-nome"></h4>
            <p class="produto-descricao">Escolha o tamanho desejado:</p>
          </div>
        </div>
        
        <div class="tamanhos-lista" id="tamanhosList">
        </div>
        
        <div class="quantidade-controls">
          <label for="modalQuantidade">Quantidade:</label>
          <div class="qty-input">
            <button type="button" class="qty-btn" data-action="decrease">-</button>
            <input type="number" id="modalQuantidade" value="1" min="1" max="99">
            <button type="button" class="qty-btn" data-action="increase">+</button>
          </div>
        </div>
      </div>
      
      <footer class="modal-footer">
        <button type="button" class="btn btn-secondary modal-cancelar">Cancelar</button>
        <button type="button" class="btn btn-primary modal-adicionar" disabled>
          <span class="btn-text">Adicionar ao Carrinho</span>
          <span class="btn-preco">R$ 0,00</span>
        </button>
      </footer>
    </div>
  </div>
  <!-- ========== /MODAL SELEÇÃO DE TAMANHOS ========== -->

  <script nonce="<%= cspNonce %>" src="/cardapio/cardapio.js"></script>
</body>
</html>
